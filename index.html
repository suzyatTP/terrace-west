<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Terrace West</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: auto;
    }
    .wrapper {
      width: 6000px;
      height: 1200px;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .seat {
      cursor: pointer;
    }
    .label, .name-line {
      font-size: 10px;
      text-anchor: middle;
      pointer-events: none;
    }
    .name-line {
      font-size: 8px;
      fill: #333;
      dominant-baseline: central;
    }
    .row-label {
      font-size: 16px;
      fill: red;
      font-family: sans-serif;
      font-weight: 400;
      dominant-baseline: middle;
      text-anchor: middle;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <svg viewBox="0 0 6000 1200" xmlns="http://www.w3.org/2000/svg">
      <g id="seats"></g>
      <g id="row-labels"></g>
    </svg>
  </div>

  <script>
    const svgNS = "http://www.w3.org/2000/svg";
    const seatGroup = document.getElementById("seats");
    const labelGroup = document.getElementById("row-labels");

    const rows = [
      { label: 'B', y: 400, start: 92, count: 46 }, // Row B: 92 to 2
      { label: 'A', y: 600, start: 94, count: 47 }  // Row A: 94 to 2
    ];

    rows.forEach(row => {
      const spacing = 40;
      const seatNumbers = Array.from({ length: row.count }, (_, i) => row.start - i * 2);
      const startX = 200;
      let firstX = startX, lastX;

      seatNumbers.forEach((seatNumber, i) => {
        const x = startX + i * spacing;
        const y = row.y;
        lastX = x;

        const seatWrapper = document.createElementNS(svgNS, "g");
        seatWrapper.setAttribute("cursor", "pointer");

        const rect = document.createElementNS(svgNS, "rect");
        rect.setAttribute("x", x - 20);
        rect.setAttribute("y", y - 25);
        rect.setAttribute("width", 40);
        rect.setAttribute("height", 50);
        rect.setAttribute("rx", 6);
        rect.setAttribute("ry", 6);
        rect.setAttribute("class", "seat");
        rect.style.fill = "#ccc";
        rect.style.stroke = "#999";

        const label = document.createElementNS(svgNS, "text");
        label.setAttribute("x", x);
        label.setAttribute("y", y - 6);
        label.setAttribute("class", "label");
        label.textContent = seatNumber;

        const nameLine1 = document.createElementNS(svgNS, "text");
        nameLine1.setAttribute("x", x);
        nameLine1.setAttribute("y", y + 6);
        nameLine1.setAttribute("class", "name-line");

        const nameLine2 = document.createElementNS(svgNS, "text");
        nameLine2.setAttribute("x", x);
        nameLine2.setAttribute("y", y + 16);
        nameLine2.setAttribute("class", "name-line");

        seatWrapper.appendChild(rect);
        seatWrapper.appendChild(label);
        seatWrapper.appendChild(nameLine1);
        seatWrapper.appendChild(nameLine2);
        seatGroup.appendChild(seatWrapper);

        seatWrapper.addEventListener("click", () => {
          const input = prompt(`Assign a name to seat ${seatNumber} (Row ${row.label}, or type 'x' to blackout):`);
          if (input === null) return;

          const trimmed = input.trim().toLowerCase();

          if (trimmed === "x") {
            rect.style.fill = "#000";
            rect.style.stroke = "#000";
            label.setAttribute("visibility", "hidden");
            nameLine1.setAttribute("visibility", "hidden");
            nameLine2.setAttribute("visibility", "hidden");
          } else {
            rect.style.fill = "#ccc";
            rect.style.stroke = "#999";

            const words = trimmed.split(/\s+/);
            const mid = Math.ceil(words.length / 2);
            nameLine1.textContent = words.slice(0, mid).join(' ');
            nameLine2.textContent = words.slice(mid).join(' ');

            label.setAttribute("visibility", "visible");
            nameLine1.setAttribute("visibility", "visible");
            nameLine2.setAttribute("visibility", "visible");
          }
        });
        // Auto-save all seats after every edit
            const allData = {};
            document.querySelectorAll('#seats > g').forEach(seat => {
              const seatId = seat.querySelector('.label')?.textContent;
              const rect = seat.querySelector('rect');
              const texts = seat.querySelectorAll('.name-line');

              if (seatId) {
                const isBlack = rect.style.fill === "rgb(0, 0, 0)" || rect.style.fill === "#000";
                if (isBlack) {
                  allData[seatId] = ["x"];
                } else {
                  allData[seatId] = [texts[0]?.textContent || "", texts[1]?.textContent || ""];
                }
              }
            });

            fetch('/save', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(allData)
            });

      });

      // Row labels & Attributes!
      const leftLabel = document.createElementNS(svgNS, "text");
      leftLabel.setAttribute("x", firstX - 60);
      leftLabel.setAttribute("y", row.y);
      leftLabel.setAttribute("class", "row-label");
      leftLabel.textContent = row.label;

      const rightLabel = document.createElementNS(svgNS, "text");
      rightLabel.setAttribute("x", lastX + 60);
      rightLabel.setAttribute("y", row.y);
      rightLabel.setAttribute("class", "row-label");
      rightLabel.textContent = row.label;

      labelGroup.appendChild(leftLabel);
      labelGroup.appendChild(rightLabel);
    });
  </script>
</body>
</html>
